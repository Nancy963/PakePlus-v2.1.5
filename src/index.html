<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¥½çœ - æç®€æ¯”ä»·</title>
    <style>
        :root {
            --primary: #2563eb;
            --success: #22c55e;
            --danger: #ef4444;
            --bg: #f1f5f9;
            --card: #ffffff;
            --text: #0f172a;
            --sub-text: #64748b;
            --border: #e2e8f0;
            --placeholder: #cbd5e1; /* 1. æ›´æµ…çš„å ä½ç¬¦é¢œè‰² */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            line-height: 1.4;
            padding-bottom: 40px; 
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        .header {
            background: var(--card);
            height: 50px;
            padding: 0 15px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            margin: 0;
            font-size: 17px;
            font-weight: 700;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }
        .header-btn {
            font-size: 15px;
            color: var(--primary);
            cursor: pointer;
            padding: 5px 0;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .container {
            padding: 10px 12px;
            max-width: 600px;
            margin: 0 auto;
        }

        /* è¾“å…¥å¡ç‰‡ */
        .input-card {
            background: var(--card);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 8px;
            box-shadow: 0 1px 1px rgba(0,0,0,0.03);
            position: relative;
        }
        .remove-row {
            position: absolute;
            top: 8px; 
            right: 8px;
            color: #cbd5e1;
            font-size: 22px;
            line-height: 1;
            cursor: pointer;
            padding: 0 5px;
            z-index: 10;
        }

        .form-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        .form-group {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-size: 11px; 
            color: var(--sub-text);
            margin-bottom: 3px;
            display: flex;
            align-items: center;
        }
        
        .required-star {
            color: var(--danger);
            margin-right: 2px;
            font-weight: bold;
        }
        .label-note {
            font-weight: normal;
            color: #94a3b8;
            margin-left: 2px;
            font-size: 10px;
        }
        
        /* è¾“å…¥æ¡†åŸºç¡€æ ·å¼ */
        input {
            width: 100%;
            /* 2. å¼ºåˆ¶é«˜åº¦ç»Ÿä¸€ */
            height: 38px; 
            padding: 0 10px; /* åªæ§åˆ¶å·¦å³paddingï¼Œä¸Šä¸‹ç”±line-heightå±…ä¸­ */
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
            outline: none;
            background: #fdfdfd;
            font-weight: 500;
        }
        input:focus {
            border-color: var(--primary);
            background: #fff;
        }
        
        /* 1. å ä½ç¬¦å¼±åŒ–ä¼˜åŒ– */
        input::placeholder {
            color: var(--placeholder);
            font-weight: normal;
            font-size: 13px; /* ç¨å¾®å°ä¸€ç‚¹ */
            opacity: 1; /* Firefoxéœ€è¦ */
        }

        /* å•†å“åç§°å­—ä½“å˜å°ï¼Œä½†é«˜åº¦å·²é€šè¿‡ input ç»Ÿä¸€ */
        .input-name {
            font-size: 14px; /* å°ä¸€å·å­—ä½“ */
            color: #475569;
        }

        .input-wrapper { position: relative; }
        .suffix {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
            font-size: 13px;
            pointer-events: none;
        }
        input.has-suffix { padding-right: 30px; }

        .calc-preview {
            font-size: 11px;
            color: var(--primary);
            height: 14px;
            margin-top: 1px;
            text-align: right;
        }

        /* æŒ‰é’®åŒº */
        .actions {
            display: flex;
            gap: 8px;
            margin: 15px 0 20px 0;
        }
        .btn {
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            padding: 12px 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-reset { background: #fee2e2; color: var(--danger); flex: 1; }
        .btn-calc { background: var(--primary); color: white; flex: 2.5; box-shadow: 0 2px 5px rgba(37,99,235,0.2); }
        .btn-add { background: #e2e8f0; color: var(--text); flex: 1; }

        /* ç»“æœåŒº */
        #result-area {
            display: none;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #cbd5e1;
        }
        .result-title {
            font-size: 13px;
            color: var(--sub-text);
            margin-bottom: 10px;
            text-align: center;
        }

        .result-item {
            background: var(--card);
            padding: 10px 12px;
            border-radius: 8px;
            margin-bottom: 6px;
            border-left: 3px solid transparent;
            box-shadow: 0 1px 1px rgba(0,0,0,0.03);
        }
        .result-item.best {
            border-left-color: var(--success);
            background: #f0fdf4;
        }
        
        .res-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 4px;
        }
        .res-name {
            font-weight: 600;
            font-size: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 55%;
        }
        .unit-price {
            font-size: 17px;
            font-family: -apple-system, monospace;
            font-weight: 700;
            color: var(--primary);
        }
        .unit-price small {
            font-size: 11px;
            color: var(--sub-text);
            font-weight: normal;
        }
        
        .sub-info {
            font-size: 11px;
            color: #94a3b8;
            margin-bottom: 6px;
        }

        /* è§†è§‰æ¡å½¢å›¾ */
        .bar-container {
            width: 100%;
            height: 20px;
            background: #f1f5f9;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: center;
        }
        .bar { height: 100%; }
        .bar.green { background: var(--success); }
        .bar.red { background: #fda4af; }
        
        .bar-label {
            position: absolute;
            font-size: 11px;
            font-weight: bold;
            z-index: 2;
            white-space: nowrap;
            color: #fff;
            left: 8px; /* ç»Ÿä¸€å·¦å¯¹é½ */
            text-shadow: 0 0 2px rgba(0,0,0,0.1);
        }

        /* å¼¹çª— */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 12px;
            width: 85%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .history-item {
            border-bottom: 1px solid var(--border);
            padding: 12px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .history-info { cursor: pointer; flex: 1; }
        .history-title { font-weight: 600; font-size: 14px; margin-bottom: 2px;}
        .history-date { font-size: 11px; color: #94a3b8; }
        .history-del { color: var(--danger); padding: 5px 0 5px 15px; font-size: 18px; }

    </style>
</head>
<body>

<div class="header">
    <div class="header-btn" onclick="openHistory()">ğŸ“œ å†å²</div>
    <h1>å¥½çœ</h1>
    <!-- 3. å›¾æ ‡æ›´æ¢ä¸ºæ˜Ÿæ˜Ÿ -->
    <div class="header-btn" onclick="saveRecord()">â­ï¸ ä¿å­˜</div>
</div>

<div class="container">
    <div id="input-list"></div>

    <div class="actions">
        <button class="btn btn-reset" onclick="resetAll()">é‡ç½®</button>
        <button class="btn btn-calc" onclick="calculate()">ğŸš€ å¼€å§‹æ¯”ä»·</button>
        <button class="btn btn-add" onclick="addInputRow()">+ åŠ å“</button>
    </div>

    <div id="result-area">
        <div class="result-title">â€”â€” è¶Šé ä¸Šè¶Šåˆ’ç®— â€”â€”</div>
        <div id="result-list"></div>
    </div>
</div>

<div id="historyModal" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h2 style="margin:0; font-size:18px;">å†å²è®°å½•</h2>
            <span onclick="closeModal('historyModal')" style="font-size:24px; cursor:pointer; color:#94a3b8;">&times;</span>
        </div>
        <div id="history-list"></div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        addInputRow();
        addInputRow();
    });

    // === 1. è¾“å…¥é€»è¾‘ ===

    function addInputRow(data = null) {
        const list = document.getElementById('input-list');
        const div = document.createElement('div');
        div.className = 'input-card';
        
        const removeBtn = `<span class="remove-row" onclick="removeRow(this)">Ã—</span>`;
        
        div.innerHTML = `
            ${removeBtn}
            
            <!-- ç¬¬ä¸€æ’ï¼šæ ¸å¿ƒæ•°å­— -->
            <div class="form-row">
                <div class="form-group">
                    <label><span class="required-star">*</span>ä»·æ ¼</label>
                    <div class="input-wrapper">
                        <input type="number" inputmode="decimal" class="input-price nav-input has-suffix" placeholder="0" value="${data ? data.price : ''}">
                        <span class="suffix">å…ƒ</span>
                    </div>
                </div>
                <div class="form-group">
                    <label><span class="required-star">*</span>æ•°é‡ <span class="label-note">(æ”¯æŒç®—å¼)</span></label>
                    <input type="text" inputmode="text" class="input-qty nav-input" placeholder="å¦‚ 10*5" value="${data ? data.qtyRaw : ''}" oninput="updateMathPreview(this)">
                    <div class="calc-preview"></div>
                </div>
            </div>

            <!-- ç¬¬äºŒæ’ï¼šè¾…åŠ©åç§° (input-name å·²ç»Ÿä¸€é«˜åº¦) -->
            <div class="form-group">
                <input type="text" class="input-name nav-input" placeholder="å•†å“åç§° (é€‰å¡«)" value="${data ? data.name : ''}">
            </div>
        `;
        
        list.appendChild(div);

        if(data && data.qtyRaw) {
            updateMathPreview(div.querySelector('.input-qty'));
        }

        bindEnterNavigation(div);
    }

    function removeRow(btn) {
        if(document.querySelectorAll('.input-card').length <= 1) return; 
        btn.parentElement.remove();
    }

    function resetAll() {
        if(confirm("ç¡®å®šæ¸…ç©ºæ‰€æœ‰å†…å®¹å—ï¼Ÿ")) {
            document.getElementById('input-list').innerHTML = '';
            document.getElementById('result-area').style.display = 'none';
            addInputRow();
            addInputRow();
        }
    }

    function bindEnterNavigation(container) {
        const inputs = container.querySelectorAll('.nav-input');
        inputs.forEach(input => {
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const allInputs = Array.from(document.querySelectorAll('.nav-input'));
                    const currentIndex = allInputs.indexOf(this);
                    if (currentIndex < allInputs.length - 1) {
                        allInputs[currentIndex + 1].focus();
                    } else {
                        addInputRow();
                        setTimeout(() => {
                            const newInputs = document.querySelectorAll('.nav-input');
                            newInputs[newInputs.length - 3].focus(); 
                        }, 50);
                    }
                }
            });
        });
    }

    function updateMathPreview(input) {
        const preview = input.parentElement.querySelector('.calc-preview');
        let val = input.value.trim().replace(/Ã—/g, '*').replace(/Ã·/g, '/');
        
        if (!val) {
            preview.innerText = '';
            return;
        }

        try {
            if (/[^0-9\.\+\-\*\/\(\)\s]/.test(val)) {
                preview.innerText = '';
                return;
            }
            const result = new Function('return ' + val)();
            if (isFinite(result) && result != val) {
                preview.innerText = `= ${parseFloat(result.toFixed(4))}`;
            } else {
                preview.innerText = '';
            }
        } catch (e) {
            preview.innerText = '';
        }
    }

    // === 2. æ¯”ä»·æ ¸å¿ƒ ===

    function calculate() {
        const cards = document.querySelectorAll('.input-card');
        let products = [];
        let hasError = false;

        cards.forEach((card, index) => {
            const name = card.querySelector('.input-name').value.trim() || `å•†å“ ${index + 1}`;
            const priceStr = card.querySelector('.input-price').value;
            const qtyStr = card.querySelector('.input-qty').value.replace(/Ã—/g, '*').replace(/Ã·/g, '/');
            
            if (!priceStr || !qtyStr) return;

            const price = parseFloat(priceStr);
            let qty = 0;

            try {
                if (/[^0-9\.\+\-\*\/\(\)\s]/.test(qtyStr)) throw new Error();
                qty = new Function('return ' + qtyStr)();
            } catch(e) { hasError = true; }

            if (price > 0 && qty > 0) {
                products.push({
                    name: name,
                    price: price,
                    qtyRaw: card.querySelector('.input-qty').value,
                    qtyVal: parseFloat(qty.toFixed(4)),
                    unitPrice: price / qty
                });
            }
        });

        if (hasError) { alert("éƒ¨åˆ†æ•°é‡æ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥"); return; }
        if (products.length < 1) { alert("è¯·è‡³å°‘å¡«å†™ä¸€ä¸ªå®Œæ•´çš„å•†å“"); return; }

        products.sort((a, b) => a.unitPrice - b.unitPrice);
        renderResults(products);
    }

    function renderResults(products) {
        const resultArea = document.getElementById('result-area');
        const list = document.getElementById('result-list');
        resultArea.style.display = 'block';
        list.innerHTML = '';

        const bestPrice = products[0].unitPrice;

        products.forEach((p, index) => {
            const isBest = index === 0;
            const premium = ((p.unitPrice - bestPrice) / bestPrice) * 100;
            const displayUnit = parseFloat(p.unitPrice.toFixed(4));
            
            let icon = 'ğŸ›’';
            if (index === 0) icon = 'ğŸ”¥';
            else if (index === 1) icon = 'ğŸ¥ˆ';
            else if (index === 2) icon = 'ğŸ¥‰';

            let barHtml = '';
            let widthPercent = isBest ? 40 : (40 + (premium * 0.5));
            if (widthPercent > 100) widthPercent = 100;

            const text = isBest ? 'ğŸ”¥ æœ€åˆ’ç®—' : `ğŸ”º è´µ ${premium.toFixed(1)}%`;
            const colorClass = isBest ? 'green' : 'red';
            
            barHtml = `
                <div class="bar ${colorClass}" style="width: ${widthPercent}%;"></div>
                <span class="bar-label">${text}</span>
            `;

            const item = document.createElement('div');
            item.className = `result-item ${isBest ? 'best' : ''}`;
            
            item.innerHTML = `
                <div class="res-header">
                    <span class="res-name">${icon} ${p.name}</span>
                    <span class="unit-price">${displayUnit} <small>å…ƒ/å•ä½</small></span>
                </div>
                <div class="sub-info">${p.price}å…ƒ / ${p.qtyVal}</div>
                <div class="bar-container">
                    ${barHtml}
                </div>
            `;
            list.appendChild(item);
        });

        resultArea.scrollIntoView({ behavior: 'smooth' });
    }

    // === 3. æ•°æ®å­˜å‚¨ ===

    const STORAGE_KEY = 'haosheng_history';

    function saveRecord() {
        const cards = document.querySelectorAll('.input-card');
        const products = [];
        cards.forEach((card) => {
            const name = card.querySelector('.input-name').value;
            const price = card.querySelector('.input-price').value;
            const qty = card.querySelector('.input-qty').value;
            if(price || qty) {
                products.push({ name, price, qtyRaw: qty });
            }
        });

        if (products.length === 0) {
            alert("æ²¡æœ‰å¯ä¿å­˜çš„æ•°æ®");
            return;
        }

        const dateStr = new Date().toLocaleString('zh-CN', {month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'});
        const defaultName = `æ¯”ä»· ${dateStr}`;
        const recordName = prompt("ç»™è¿™æ¡è®°å½•èµ·ä¸ªåå­—ï¼š", defaultName);
        
        if (recordName) {
            const record = {
                id: Date.now(),
                title: recordName,
                time: dateStr,
                data: products
            };
            const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            history.unshift(record);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
            alert("å·²ä¿å­˜åˆ°å†å²è®°å½•");
        }
    }

    function openHistory() {
        const modal = document.getElementById('historyModal');
        const list = document.getElementById('history-list');
        const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');

        modal.style.display = 'flex';
        list.innerHTML = '';

        if (history.length === 0) {
            list.innerHTML = '<p style="text-align:center;color:#94a3b8;padding:20px;">æš‚æ— è®°å½•</p>';
            return;
        }

        history.forEach(item => {
            const div = document.createElement('div');
            div.className = 'history-item';
            div.innerHTML = `
                <div class="history-info" onclick="loadHistory(${item.id})">
                    <div class="history-title">${item.title}</div>
                    <div class="history-date">${item.time} Â· ${item.data.length}å“</div>
                </div>
                <div class="history-del" onclick="deleteHistory(${item.id})">ğŸ—‘ï¸</div>
            `;
            list.appendChild(div);
        });
    }

    function loadHistory(id) {
        const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        const record = history.find(r => r.id === id);
        if (record) {
            const list = document.getElementById('input-list');
            list.innerHTML = '';
            record.data.forEach(item => addInputRow(item));
            closeModal('historyModal');
            calculate(); 
        }
    }

    function deleteHistory(id) {
        if(confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) {
            let history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            history = history.filter(r => r.id !== id);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
            openHistory();
        }
    }

    function closeModal(id) {
        document.getElementById(id).style.display = 'none';
    }
    
    window.onclick = function(event) {
        const modal = document.getElementById('historyModal');
        if (event.target == modal) modal.style.display = "none";
    }
</script>

</body>
</html>